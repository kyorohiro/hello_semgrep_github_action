name: semgrep

on:
  pull_request:
    paths:
      - 'src/**'
      - '.github/**'
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history for baseline if you later add diff scan)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # Semgrep を JSON で出す（検出があっても続行）
      - name: Run Semgrep (JSON + SARIF)
        id: semgrep
        shell: bash
        run: |
          set -euo pipefail
          semgrep --version

          # 機械用（集計・Slack用）
          semgrep scan --config auto --json . | tee semgrep.json || true

          # 人間用（GitHub UI で見れる）
          semgrep scan --config auto . > ../semgrep.log 2>&1|| true

      # JSON から独自 Summary を作る（Slack用 semgrep.txt を生成）
      - name: Build Summary (JSON -> TXT/MD)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          from collections import Counter
          from pathlib import Path

          data = json.loads(Path("semgrep.json").read_text())
          results = data.get("results") or []
          errors = data.get("errors") or []

          total = len(results)
          error_count = len(errors)

          by_rule = Counter((r.get("check_id") or r.get("rule_id") or "?") for r in results)
          by_file = Counter((r.get("path") or "?") for r in results)

          def sev(r):
            return ((r.get("extra") or {}).get("severity") or "UNKNOWN").upper()
          by_sev = Counter(sev(r) for r in results)

          # TXT（Slack用、短め）
          lines = []
          lines.append(f"Semgrep Summary")
          lines.append(f"- findings: {total}")
          if error_count:
            lines.append(f"- errors: {error_count}")
          if total:
            lines.append(f"- severity: " + ", ".join(f"{k}:{v}" for k,v in sorted(by_sev.items())))
            lines.append("")
            lines.append("Top rules:")
            for rid, cnt in by_rule.most_common(10):
              lines.append(f"- {rid}: {cnt}")
            lines.append("")
            lines.append("Sample findings:")
            for r in results[:20]:
              path = r.get("path","?")
              start = (r.get("start") or {}).get("line","?")
              rid = (r.get("check_id") or r.get("rule_id") or "?")
              msg = ((r.get("extra") or {}).get("message") or "").replace("\n"," ")
              lines.append(f"- {path}:{start} [{rid}] {msg}".strip())

          out_txt = "\n".join(lines)[:3000]
          Path("semgrep.txt").write_text(out_txt, encoding="utf-8")

          # MD（人間用、少し丁寧）
          md = []
          md.append("# Semgrep report\n")
          md.append(f"- findings: **{total}**")
          if error_count:
            md.append(f"- errors: **{error_count}**")
          if total:
            md.append(f"- severity: " + ", ".join(f"**{k}**:{v}" for k,v in sorted(by_sev.items())))
            md.append("\n## Top rules")
            for rid, cnt in by_rule.most_common(20):
              md.append(f"- `{rid}`: {cnt}")
            md.append("\n## Top files")
            for fp, cnt in by_file.most_common(20):
              md.append(f"- `{fp}`: {cnt}")
            md.append("\n## Findings (first 50)")
            for r in results[:50]:
              path = r.get("path","?")
              start = (r.get("start") or {}).get("line","?")
              rid = (r.get("check_id") or r.get("rule_id") or "?")
              msg = ((r.get("extra") or {}).get("message") or "").replace("\n"," ")
              md.append(f"- `{path}:{start}` **{rid}** — {msg}")

          Path("semgrep.md").write_text("\n".join(md), encoding="utf-8")
          print(out_txt)
          PY

      - name: Upload Semgrep artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-log
          path: |
            semgrep.txt
            semgrep.md
            semgrep.json
            semgrep.log

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "SLACK_WEBHOOK_URL is empty; skip Slack notification."
            exit 0
          fi

          export RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          export BODY="$(cat semgrep.txt | sed -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//')"

          python .github/ci/payload_gen.py > payload.json

          curl -sS -X POST \
            -H "Content-type: application/json" \
            --data-binary @payload.json \
            "$SLACK_WEBHOOK_URL"
