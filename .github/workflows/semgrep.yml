name: semgrep-basic

on:
  pull_request:
    paths:
      - 'src/**'
      - '.github/**'
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history for baseline if you later add diff scan)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep pyyaml

      # Semgrep を JSON で出す（検出があっても続行）
      - name: Run Semgrep (JSON + SARIF)
        id: semgrep
        shell: bash
        run: |
          set -euo pipefail
          semgrep --version
          OUT_JSON="${GITHUB_WORKSPACE}/semgrep.json"
          OUT_LOG="${GITHUB_WORKSPACE}/semgrep.log"
           # 解析用
          CMD_JSON="$(python ./.github/ci/build.py --json)"
          echo "RUN(JSON): ${CMD_JSON}"
          bash -lc "${CMD_JSON}" | tee "${OUT_JSON}" || true
          # 人用
          CMD_LOG="$(python ./.github/ci/build.py)"
          echo "RUN(LOG): ${CMD_LOG}"
          bash -lc "${CMD_LOG}" > "${OUT_LOG}" 2>&1 || true
#          # 機械用（集計・Slack用）
#          semgrep scan --config auto --json . | tee semgrep.json || true
#
#          # 人間用（GitHub UI で見れる）
#          semgrep scan --config auto . > ./semgrep.log 2>&1|| true
#

      # JSON から独自 Summary を作る（Slack用 semgrep.txt を生成）
      - name: Build Summary (JSON -> TXT/MD)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          python "${GITHUB_WORKSPACE}/.github/ci/summary_gen.py" \
            --json "${GITHUB_WORKSPACE}/semgrep.json" \
            --out-txt "${GITHUB_WORKSPACE}/semgrep.txt" \
            --out-md "${GITHUB_WORKSPACE}/semgrep.md"
#            --setting "${GITHUB_WORKSPACE}/.github/settings/semgrep_basic_setting.yml" \

      - name: Upload Semgrep artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-log
          path: |
            semgrep.txt
            semgrep.md
            semgrep.json
            semgrep.log

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "SLACK_WEBHOOK_URL is empty; skip Slack notification."
            exit 0
          fi

          export RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          export BODY="$($SLACK_WEBHOOK_URL cat semgrep.txt | sed -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//')"

          python .github/ci/payload_gen.py > payload.json

          curl -sS -X POST \
            -H "Content-type: application/json" \
            --data-binary @payload.json \
            "$SLACK_WEBHOOK_URL"
