name: semgrep

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # Semgrep 実行結果をファイルへ。検出があっても続行するため || true
      - name: Run Semgrep (p/ci)
        id: semgrep
        run: |
          set -eu
          semgrep --version
          semgrep --config p/ci . 2>&1 | tee semgrep.txt || true
      - name: Upload Semgrep log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-log
          path: semgrep.txt
      # Slack に送るために 1000文字にカット（行単位がよければ head -n でもOK）
      - name: Cut output
        if: always()
        run: |
          set -eu
          head -c 1000 semgrep.txt > semgrep_short.txt || true
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
        run: |
          set -eu

          RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"

          # 例: semgrep.txt の先頭1000文字を BODY に入れる（必要なら）
          BODY="$(head -c 1000 semgrep.txt | sed 's/`/\\`/g')"

          payload=$(cat <<JSON
          {
            "text": "Semgrep ${JOB_STATUS} - ${REPO}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Semgrep ${JOB_STATUS}*\\n*Repo:* ${REPO}\\n*Ref:* ${REF}\\n*Event:* ${EVENT}\\n*Actor:* ${ACTOR}\\n*Run:* <${RUN_URL}|Open GitHub Actions run>"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Output (first 1000 chars)*\\n```\\n${BODY}\\n```"
                }
              }
            ]
          }
          JSON
              )

              curl -sS -X POST \
                -H "Content-type: application/json" \
                --data "$payload" \
                "$SLACK_WEBHOOK_URL"

