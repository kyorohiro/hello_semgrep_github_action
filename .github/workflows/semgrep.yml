#
# 差分だけ取得
#
name: semgrep

on:
  pull_request:
    paths:
      - 'src/**'
      - '.github/**'
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history for baseline)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep (r/all, only new findings when baseline exists)
        id: semgrep
        shell: bash
        run: |
          set -euo pipefail
          semgrep --version
          semgrep scan --config r/all --json . | tee semgrep.json

          # Slack 用に短いテキストを作る（JSONから生成）
          python - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("semgrep.json").read_text())
          results = data.get("results", []) or []
          n = len(results)

          lines = [f"Semgrep new findings: {n}"]
          for r in results[:50]:
            path = r.get("path","?")
            start = (r.get("start") or {}).get("line","?")
            rid = (r.get("check_id") or r.get("rule_id") or "?")
            msg = ((r.get("extra") or {}).get("message") or "").replace("\n"," ")
            lines.append(f"- {path}:{start} [{rid}] {msg}".strip())

          out = "\n".join(lines)
          Path("semgrep.txt").write_text(out[:3000], encoding="utf-8")
          print(out[:3000])
          PY

          # 新規 findings があれば fail（落としたくないならこのブロックを消す）
          # python - <<'PY'
          # import json, sys
          # data = json.load(open("semgrep.json","r"))
          # n = len(data.get("results", []) or [])
          # sys.exit(1 if n > 0 else 0)
          # PY

      - name: Upload Semgrep artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-log
          path: |
            semgrep.txt
            semgrep.json

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "SLACK_WEBHOOK_URL is empty; skip Slack notification."
            exit 0
          fi

          export RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          export BODY="$(cat semgrep.txt 2>/dev/null || echo 'semgrep.txt missing')"
          export SUB="New Findings"

          python .github/ci/payload_gen.py > payload.json

          curl -sS -X POST \
            -H "Content-type: application/json" \
            --data-binary @payload.json \
            "$SLACK_WEBHOOK_URL"
