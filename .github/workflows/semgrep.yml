name: semgrep

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  semgrep:
    runs-on: ubuntu-latest
    #environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # Semgrep 実行結果をファイルへ。検出があっても続行するため || true
      - name: Run Semgrep (p/ci)
        id: semgrep
        run: |
          set -eu
          semgrep --version
          semgrep --config p/ci . 2>&1 | tee semgrep.txt || true
      - name: Upload Semgrep log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-log
          path: semgrep.txt
      # Slack に送るために 1000文字にカット（行単位がよければ head -n でもOK）
      - name: Notify Slack
        if: ${{ always() }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          REF: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
        run: |
          set -euo pipefail

          # secret が無い（fork PR等）なら通知しない
          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "SLACK_WEBHOOK_URL is empty; skip Slack notification."
            exit 0
          fi

          export RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          export BODY="$(
            head -c 3000 semgrep.txt 2>/dev/null \
            | sed -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//'
          )"

          python .github/ci/payload_gen.py > payload.json

          curl -sS -X POST \
            -H "Content-type: application/json" \
            --data-binary @payload.json \
            "$SLACK_WEBHOOK_URL"
